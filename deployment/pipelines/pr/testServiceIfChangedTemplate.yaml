parameters:
  service: ''

jobs:
- job:
  displayName: Test ${{parameters.service}} Service
  pool:
      vmImage: 'ubuntu-latest'
  steps:

  # Check if this service has been edited in the PR
  - script: |
      continue=`git diff origin/master... --name-only | cut -d / -f 1 | grep ${{parameters.service}} -cim1`
      echo "##vso[task.setvariable variable=continue]$continue"
    
  # This service has been edited so let's test it
  - task: DotNetCoreCLI@2
    displayName: Unit Test
    condition: eq(variables['continue'], '1')
    inputs:
      command: test
      projects: '${{parameters.service}}/**/*Test.csproj'

  - task: Bash@3
    displayName: Install Newman
    condition: and(always(), eq(variables['continue'], '1'))
    inputs:
      targetType: 'inline'
      script: |
        sudo npm install newman -g

  - task: NewmanPostman@4
    displayName: Run Postman Integration Tests
    condition: and(always(), eq(variables['continue'], '1'))
    inputs:
      collectionSourceType: 'file'
      Contents: '${{parameters.service}}/**/WebService.Test/testCollection.json'
      environmentSourceType: 'none'
      reporters: 'cli,junit'
      reporterJUnitExport: $(System.DefaultWorkingDirectory)/${{parameters.service}}-integration-test-report.xml

  - task: PublishTestResults@2
    condition: and(always(), eq(variables['continue'], '1'))
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/${{parameters.service}}-integration-test-report.xml'