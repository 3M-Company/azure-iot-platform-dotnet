# Docker
# Build a Docker image 
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  branches:
    include:
    - master
  paths:
    include:
    - config/

pr:
  branches:
    include:
    - master
  paths:
    include:
    - config/

resources:
- repo: self

variables:
  tag: '$(Build.BuildId)'

jobs:
- job: Build
  displayName: Build
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: DotNetCoreInstaller@2
    inputs:
      version: '2.2.402'

  # - task: Docker@2
  #   displayName: Build the Image
  #   inputs:
  #     command: build
  #     dockerfile: '$(Build.SourcesDirectory)/config/WebService/Dockerfile'
  #     buildContext: '$(Build.SourcesDirectory)/config'
  #     tags: |
  #       $(tag)
      
  - task: DotNetCoreCLI@2
    displayName: Unit Test
    inputs:
      command: test
      projects: '$(System.DefaultWorkingDirectory)/config/WebService.Test/*.csproj'

  - task: AzureCLI@1
    displayName: Start Up Container in New Dev Space
    inputs:
      azureSubscription: '3M-CRSLAD16-BBIoTP-Dev'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az aks use-dev-spaces -g rg-crslbbiot-odin-dev -n aks-dev-spaces-odin -s config-build -y
        kubectl create secret generic globalsecrets --from-literal=passphrase=topsecret
        cd $(System.DefaultWorkingDirectory)/config/WebService
        azds up

  # Integration test
  
  # - task: AzureCLI@1
  #   displayName: Delete Dev Space
  #   inputs:
  #     azureSubscription: '3M-CRSLAD16-BBIoTP-Dev'
  #     scriptLocation: 'inlineScript'
  #     inlineScript: |
  #       az aks use-dev-spaces -g rg-crslbbiot-odin-dev -n aks-dev-spaces-odin -s config-build
  #       azds space remove -n config-build -y