# Docker
# Build a Docker image 
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  branches:
    include:
    - master
  paths:
    include:
    - config/

pr:
  branches:
    include:
    - master
  paths:
    include:
    - config/

resources:
- repo: self

variables:
  tag: '$(Build.BuildId)'

jobs:
- job: Build
  displayName: Build
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  # - task: DotNetCoreInstaller@2
  #   inputs:
  #     version: '2.2.402'

  # # - task: Docker@2
  # #   displayName: Build the Image
  # #   inputs:
  # #     command: build
  # #     dockerfile: '$(Build.SourcesDirectory)/config/WebService/Dockerfile'
  # #     buildContext: '$(Build.SourcesDirectory)/config'
  # #     tags: |
  # #       $(tag)
      
  # # - task: DotNetCoreCLI@2
  # #   displayName: Unit Test
  # #   inputs:
  # #     command: test
  # #     projects: '$(System.DefaultWorkingDirectory)/config/WebService.Test/*.csproj'

  # - task: AzureCLI@1
  #   displayName: Create New Dev Space
  #   inputs:
  #     azureSubscription: '3M-CRSLAD16-BBIoTP-Dev'
  #     scriptLocation: 'inlineScript'
  #     inlineScript: |
  #       az aks use-dev-spaces -g rg-crslbbiot-odin-dev -n aks-dev-spaces-odin -s config-build -y
  #       az aks get-credentials --resource-group rg-crslbbiot-odin-dev --name aks-dev-spaces-odin

  # - task: KubectlInstaller@0
  #   inputs:
  #     kubectlVersion: 'latest'
      
  # - task: Bash@3
  #   displayName: Add Secrets to Dev Space
  #   inputs:
  #     targetType: 'inline'
  #     script:  |
  #       kubectl create secret generic --namespace=config-build globalsecrets --from-literal=PCS_APPLICATION_CONFIGURATION=Endpoint=https://app-config-odin.azconfig.io;Id=0-l4-s0:/avC76+mF2P0dRQdykx0;Secret=/yJ835E0xwCfEPGP36FGp9lPgswgoNVLjeCOfYu34v0=

  # - task: AzureCLI@1
  #   displayName: Azds Up
  #   inputs:
  #     azureSubscription: '3M-CRSLAD16-BBIoTP-Dev'
  #     scriptLocation: 'inlineScript'
  #     inlineScript: |
  #       cd $(System.DefaultWorkingDirectory)/config/WebService
  #       azds up -d

  # Integration test
  
  - task: AzureCLI@1
    displayName: Delete Dev Space
    inputs:
      azureSubscription: '3M-CRSLAD16-BBIoTP-Dev'
      scriptLocation: 'inlineScript'
      inlineScript: |
        az aks use-dev-spaces -g rg-crslbbiot-odin-dev -n aks-dev-spaces-odin -s config-build
        azds space remove -n config-build -y